# Chapter 7 - Webシステムの構築と運用

### ○ 基本的な枠組みについて

Webシステムの設計・構築にあたっては、どの仕事においても言えることではあるが、
いわゆる５W1Hを整理する必要がある。特に以下の事項について確認する必要がある。

- WHAT　何のサービスを提供するのか
- WHO　誰を対象としたサービスなのか
- HOW　どのようにサービスを提供するのか（スマホなのかデスクトップPCなのか）
- WHEN　サービスはいつ利用されるのか

以上を明確にした後に、具体的なWebシステムの設計へと移る。
以下のような作業が必要となる。

1. Webサービスに備える機能の洗い出し
2. 各画面のデザイン（対象者や閲覧端末を意識）
3. ネットワーク基盤や構成の検討

#### ●　使用言語・ソフトウェアの検討

また、プログラミングに使用する言語・OS・ミドルウェアを選択する。

各言語には特性があるので、サービス内容に合った言語を選択する。
各言語のフレームワークについても意識する。Ruby→Railsなど。

OSについては、Windows・Linux系の２種類に大別される。
Windowsは普及率が高いが、ライセンス料がかかり、脆弱性が狙われやすい。

一方、Linuxはライセンス料がかからない（もしくは安価）。
Windowsとは異なり、CUIによる操作が基本となる。

ソフトウェアについては、Webサーバー・APサーバー・DBサーバー、
いずれについても導入するミドルウェアを決定する必要がある。

Webサーバーについては、Apacheが有名だ。
Nginxは動作が軽く、早いらしい。
IISは、Windowsとの相性がよい。

APサーバーについては、Tomcat・JBoss・IISなどがある。

DBサーバーについては、高価なものだがOracleが有名。
他、今後勉強していくであろうMySQLやPostgreSQLなどがある。
SQLサーバーは、Windowsとの相性がよい。

### ○ Webシステムの構築（インフラ面）

#### ●　ネットワークとサーバーの構成

ネットワークは、以下の３つの層で構成される。
また、各層には以下のようなサーバーを設置する。

1. 外部ネットワーク
    - 外部からのアクセスに晒されている層
    - ファイアウォールがここに属する。
        - 全てのアクセスを受け、どのアクセスを拒否するか・制限するか判断する。
2. DMZ(DeMilitarized Zone)
    - 外部ネットワークと内部ネットワークの間の層
    - 外部からのアクセスが制限されている層
    - 以下が属する。
        1. IPS(Intrusion Prevention System)
        2. IDS(Intrusion Detection System)
        3. WAF(Web Application Firewall)
        4. Webサーバー(ApecheやNgnix)
3. 内部ネットワーク
    - APサーバーやDBサーバー

Webシステムの特質を考慮して、冗長化が図られることもあれば、逆に一部の機器が設置されないこともある。
冗長化する場合、ロードバランサーという機器が設置される。クライアントからのアクセス負荷を平準化する。

運用コスト・可用性（情報がアクセスしやすい状況にあるか）・機密性などの観点から検討し、
どのように何のサーバーや機器を設置するか決定する。

#### ● サーバー基盤

サーバーの調達手段して、以下の３つがある。

1. オンプレミス
  - On Premises = 「自分の店舗内スペースで」を意味する。
  - 自前でサーバーを調達し、構築する。
  - 手間がかかるが、自由にネットワークを構築・設計できる。
  - 専門知識が必要となり、初期費用が高くつく。
    - サーバーを置くスペース、サーバーを買う費用
    - 近年、クラウドへの鞍替えが進んでいる（らしい）。
2. レンタル
  - 他者のサーバーを借りる。
  - 手間はかからないが、ネットワークの構成・設計はできない。
    - 既に用意されたものから選ぶ必要あり。
3. クラウド
  - 他者のサーバーを借りる。
  - 必要なサービスを必要な分だけ契約し、自由にネットワークを構成・設計できる。 
  - AWS(Amazon Web Services)、GCP(Google Cloud Platform)、Azureなどが有名。

#### ● 負荷分散

サーバーを冗長化した場合、サーバー負担の分散が課題となる。
主として、ロードバランサーがサーバー負担の分散の役割を担う。

分散の方法は、下記の３つがある。

1. ラウンドロビン方式
    - クライアントからのアクセスを順番に各サーバーに振り分け行く方式
    - 処理の複雑さがリクエストごとにバラツキが出る場合、負荷が偏ることもある。
    - トリビア（言葉の意味について）
  - Round Robin = 総当たり戦を意味する。
    - ラウンドロビンパーティ = 参加者各自の習慣で小さなパーティを一つずつ参加者がまわって歩くようなパーティ
    - １７世紀フランスの農民が嘆願書に署名する際、首謀者が特定されないよう中心から放射状に名前を書いたことに由来
2. 動的分散
    - サーバーの負荷状況を確認し、リクエストを振り分ける。
    - CPUやメモリの処理状況などから判断
3. パーシステンス方式
    - セッション管理をする場合、セッションが終了するまで同一サーバーとやり取りをしてもらう必要がある。
    - そのため、同一クライアントからのアクセスを判別し、同一サーバーにアクセスする。
    - persistence = 粘り強い継続性

### ○ Webシステムの設計（ソフト面）

#### ● アプリケーションの設計

1. 基本設計（外部設計）

まず、どのような機能を実装するか、どのようなデザインの画面とするかなどを決定する。
大まかな見取り図の作成。外から見える部分に関する設計なので、外部設計とも呼ばれる。

2. 詳細設計（内部設計）

実装される各種プログラムについてはモジュールと呼ばれるが、そのモジュールの設計やモジュール間の遷移を設計する。
クライアントサイドから見えない細かな見取り図の設計なので、内部設計とも呼ばれる。

3. テスト

アプリケーションの作成を終えたら、まず各モジュールごとに単体テストを行う。
単体テスト終了後、各種モジュールを連結させ、連結テストを行う。

#### ● データベースの設計

論理設計と物理設計を行う。

論理設計では、格納データの洗い出し、データ間の関係性の洗い出し、重複データの削除などを行う。
物理設計では、データの型の設定、索引の作成、DBに割り当てるディスクサイズの設定などを行う。

#### ● その他

また、一般的な話として、ディスクの構成・OSでのセキュリティに関する設定をするのはもちろんのこと、
それらの設定にミスがないか複数人でチェックするなどのシステム基盤設定が必要になる。

### ○ Webシステムの運用

#### ● バックアップの運用

データベースとアプリケーションのバックアップを行う。
データベースについては、DBMS(DB Management System)の機能を用いる。

サーバーが同一の部屋に置かれている場合、火事などが起きると全てのサーバーがダメージを受ける。
冗長化するにしても、リスク等を勘案し、違う部屋のサーバーにバックアップを取るなどして対応する。

また、定期的にバックアップを取得し、悪意の攻撃からアプリケーションやデータの改竄等が行われたとしても、
速やかに復旧できる体制を構築する必要がある。

#### ● ログの運用

システムログ、アプリケーションログ、アクセスログがある。
これらのログは蓄積されていくため、適切に管理・分析していく必要がある。

管理にあたっては、可読性を担保するため、１日や１週間などの時間単位で区切って保存することが多い。
場合によっては、ファイルサイズで区切ることもある。

ログファイルは増える一方なので、適宜自動で削除するよう設定することもある。
これをログローテーションもしくはハウスキープ（家事でのお掃除）という。

分析にあたっては、例えばWebサーバーへのアクセス情報を利用し、いつどのような人がアクセスしたか
専用ソフトを使って、サービス向上や売上増大につなげることができる。

#### ● パフォーマンスの管理

Webサービスは、パーフォマンスが重要となる。
パフォーマンスとは、ユーザーがリクエストをしてからページを表示するまでの時間などを示す言葉である。

パフォーマンスは、以下のような指標で計測される。
    - 応答時間(HTTPを通じてリクエストが返ってくる時間)
    - 表示時間(Webページが表示されるまでの時間)
    - 可用性(エラーなく、ページが表示される確率)

パフォーマンスはサーバーの負荷状況に左右されるため、同時にサーバーの負荷状況を監視することが重要である。

#### ● 脆弱性への対応

脆弱性への対応にあたっては、公開されている脆弱性データベースの確認を欠かさない。

また、独自開発したアプリケーションについては情報がないため、攻撃を受けることがないかシミュレーションテストを行う。
このシミュレーションテストを「ペネトレーションテスト」という。

自らテストを行うことが困難であったり、より専門的に確認を行いたい場合、専門業者に依頼をすることもできる。

脆弱性が発見された場合、パッチを充てることなどにより脆弱性をなくしていくことが重要であるが、
その作業により、Webシステムの動作がおかしくなることもあるので、十分な検討・テストが必要となる。

