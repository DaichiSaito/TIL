# 20200628 だいそんさん質問会

## 参加者

- だいそんさん  
- Dai Kentaroさん（臺さん）  
- りゅういちさん  
- みけた

## 質問内容

1. 公式ドキュメントの読み方・活用方法
2. ルーティング・RESTfulについて
3. データベース関連
4. 就職・今後の勉強方針

詳細は以下を参照すること  
- [事前にみけたが送りつけた質問一覧](https://github.com/miketa-webprgr/TIL/blob/master/99_etc/20200627_questions.md)

## 1. 公式ドキュメントの読み方・活用方法

### 質問１

だいそんさんは、gemの使い方が知りたい時、公式ドキュメント等をどう活用しているのか。  
よく公式を参照するといいと聞くが、未だ活用できた試しがないので質問しました！  

### 回答１

- Qiitaを先に読んでしまうことある
- Qiitaで済ませるのが悪い訳ではない
- 公式も参照するように心がけているが、重要なのはコピペで済ませないこと
- Qiita・公式ドキュメントというところよりも、どのような仕組みで動いているのか理解するのが大切

## 2. ルーティング・RESTfulについて

### 質問２

どのようにルーティングテーブルを設計すればいいか教えてください。  
（技術的に`routes.rb`をどう書くかではなく、どのような考えで設計しているかについて）  

例えば、以下のように書いた場合、URLが `admin/users/~` となるのは分かるが、  
なぜ管理者画面を作る際に使うことが多いのか。漠然とそうするとよいという事実だけ知っているが、  
実際のところ、なぜそうしているのかまでは分かっていない。  

```rb: routes.rb
namespace admin do
  resoureces :users
end
```

### 回答２

#### resources, resource について

まず意識していることは、以下の内容。  
初学者は、意識していない人が多い。

- resources（複数形）を使うべきなのか
- resource（単数形）を使うべきなのか

具体的には、以下のような事例はありえないが、初学者にありがちなミス。  
各ユーザーがいくつものプロフィールを持つことはありえないので、  
`resource`を使うのが正解となる。

```rb: broutes.rb
resources :users
  resources :profiles
end
```

`users/:id/profiles/:id`としても動きはするが、`:id`が２や３になる可能性はない。  

#### DHH流のルーティングについて

詳細はこちらを参照するとよいが、概略を以下に記す。  
[DHH流のルーティングで得られるメリットと、取り入れる上でのポイント \- KitchHike Tech Blog](https://tech.kitchhike.com/entry/2017/03/07/190739)

例えば、recipeにするpublishアクション（公開する）とunpubilish（非公開にする）アクションを追加したい場合、  
以下のとおり考えるのが自然かと思う。  

```rb: routes.rb
class RecipesController < ApplicationController
  def index
  end
  # デフォルトのCRUDアクションが続く

  def publish
    # 公開処理
  end

  def unpublish
    # 非公開処理
  end
end
```

DHH流では、以下のとおりとなる。  

```rb: routes.rb
class Recipes::PublicationsController < ApplicationController
  def update
    # 公開処理
  end

  def destroy
    # 非公開処理
  end
end
```

recipe リソースの配下に publication という公開/非公開を担うサブアクションを追加し、  
update に公開処理を、destroy に非公開処理をマッピングするとよい。  

URLは以下のイメージ。  

```text
/recipes/:id/publication
```

アクションの数が７から９に増える程度であれば問題ないが、処理が複雑になり、  
アクションの数が20にも30にも増えてきて、独自のアクション名が増え出してくると、  
コードを書いていない他の開発者が読む際に、理解をすることが困難になってくる。  

それであれば、規約にガッツリと従って、サブアクションを増やす形がよい。  
（というのが規約を大事にする、DHH流の考え方です）  

#### namespaceについて

なぜ管理画面を実装する場合に分けた方がよいかという部分については、  
実際に`namespace`なしでコードを書く場合を考えてみるとよい。  

`namespace`を使うと、`admin/users/~`というURLになるので、  
処理の実装が楽に書ける。

・・・共有してもらった動画を見て、改めて修正します 笑

##### りゅういちさんのメモ

namespaceは例えば、ログインしているユーザーだけがやりたい機能（編集とか削除）

#### moduleの使いどころ

まず、`namespace`、`module`、`scope`については以下を参照。  
[routeのmoduleとnamespaceとscopeの違い \- Qiita](https://qiita.com/blueplanet/items/522cc8364f6cf189ecad)  

このQiita記事にまとめれているとおり、`module`は`controller`の格納フォルダだけ、指定パスになる。  
例えば、就活サイトを作ると仮定した場合、`namespace`で以下のとおり分けることが考えられる。  

```rb
namespace :admin
  # 管理者用の画面
end

namespace :employers
  # 採用企業用の画面
end

namespace :employees
  # 就活する人が使う画面
end

namespace :users
  # 一般の人が見れる画面
end
```

ただ、以下の場合、一般の人が見れる画面のURLは`users/~`になってしまい、  
考え方によるかもしれないが、`users/~`とすることは避けたいはずだ。  

そういった場合、moduleを活用するとよい。  

------------------------ ここから下は作成中 ------------------------------------

#### ネスティングについて

- shallowオプションがすべての解決作ではない
  - updateとかdestroyみたいに既存のデータをいじくるときには有効
- /tasks?user_id = 1 みたいな方式にすればネスト減る？

#### 認可のgemの紹介

- 認証と認可の違い
  - 認証：ログイン
  - 認可：どのような権限付与をするか
    - 管理者権限を与えるか、投稿権限だけ与えるか、閲覧権限だけ与えるか等

- 難しくなると限界があるので、認可のgemを活用するとyい
  - Pundit
  - Banken

#### Skinny Controllerを目指すわけ

- コントローラを見やすくするため
- 現場railsのP429を参照（ロジックはモデルに寄せるとよい事例がある）

## 3. データベース関係

### 質問３

Redisとは何か？ Redisを使うと何がよいのか？
cookie_storeではなく、Redisに保存する意味とは？

Sidekiqって何ですか？SidekiqとRedisを組み合わせて、
現場Railsで使ったが、その理由はなぜか。

### 回答3

#### りゅういちさんのメモ

- key value stroe(（KVS)
  - redisはKVSの一種
- 調べるキーワード
  - cookie_store
  - redis_store（圧倒的速さ。sessionのやリ取りは、複雑な処理は必要ない）
  - redisの方が安全？
    - redisで格納してるデータを削除しちゃえば、なりすましに対応できる
    - cookie_storeはuser_id: 1って情報（secret_key_base暗号化してるけど）でやり取りしてるからやばい。
    - secret_key_baseをかえちゃえばいいけど、全ユーザーに影響いっちゃうからやばいー
  
- railsとredisの橋渡し的存在、なぜならアダプタだから
- キュー→待ち行列
- SQLは事前にschemaが必要、つまり決まった形にデータをぶちこむ必要あり
  - NOSQLは形いらない。なんでも入れれる（？）

## 4. 就職・今後の勉強方針

### 質問4

初学者が就職した場合、どのような業務を行うのか？  
達成すべきゴールをイメージし、逆算するような形で勉強したい。  

- 比較的任せられそうな機能実装やバグ修正を行って、Gitでレビューを受けて・・・というイメージ？
- SQLってどのくらい知っておけばよいのか？
  - 自作アプリ程度だとActiveRecord使えればよさそうなので、SQLコマンドを忘れていきそう
- JSの勉強はどの程度必要なのか、インフラの勉強もした方がよいのか
  - Ruby・Railsが当然軸にはなると思うが、プラスアルファとしてどこに力を入れるとよいのか
    - JS/Vueなのか、インフラなのか、データベースなのか、APIなのか、その他なのか、、、
    - AWS・Dockerはポートフォリオに導入しましょうとよく聞くが、、、  
    - 多分、全部を頑張るのは難しいと思うので、その辺りの考え方を聞きたい
    - 単純に自作アプリで使いたい技術・作りたいものに使ってみたい技術という方向性だけだと不味いような気がした

### 回答4（りゅういちさんのメモ）

SQLはJOIN、SELECTを重点的に！  

コンソールで
 .to_sql
すれば、SQL文が見れる。

- AWSとかDockerはさわりだけでOK（EC2は何？とか）
- redisの話、sidekiqの話→加点ポイント
- rails/ruby、Vueをがんばろう（htmlの中にjavascriptがある）＋APIかくこと
  - jビルダー
- インフラは諸々コストかかる
- 郵便番号投げたら住所返ってくる（APIのイメージ）
- https://qiita.com/busyoumono99/items/9b5ffd35dd521bafce47

### 質問5

remote: true 関連  

### 回答5

- やりたいことについてエンドポイントを考える
いいねするなら
likes?post_id=1 みたいに。それを満たすようにコード作る。

## ノートについて

りゅういちさんがノートを取ってくれたものをみけたが追記等しました。  
だいそんの意図と違う部分があるかもしれないですし、事実と異なる部分もあるかもしれません。。。

なので、申し訳ないですが、そこも踏まえて活用してください。
