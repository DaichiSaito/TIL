# Chapter 3 - HTTPでやり取りする仕組み

### ○ はじめに

改めて、復習です。
Webページの表示にあたっては、HTTPというプロトコルを通して、
自宅PCとサーバーとの間でやり取りがなされている。

自宅のPCが「Webページ表示しろや」と言ったら、サーバー側が「表示したるわ」と言って表示する。
そんな関係性によって成立している。では、HTTPとはどのようなものなのか。

### ○ HTTPとは

HTTPとは、どのような形でやり取りをしているのか。

具体的には、自宅のPC（リクエスト側）はこのような形でやり取りをしている。
（ブログ「ITsakura」さんより画像を拝借しました）

<img width="700" alt="WebArchitecture" src="https://itsakura.com/wp-content/uploads/2017/11/http-request-post1.svg"> <br>

まず、リクエスト行というものがある。
次に、メッセージヘッダーがある。
そして、空行を挟み、メッセージボディがある。（この画像にはないが）

#### ○ リクエスト行とは

##### ● メソッド

まず、メソッドというものがある。
先ほどの図でいうところの「GET」がそうだ。
これは、GETとHTTPの間に挟まれている、「http://~」を取得しろという意味だ。
これが、www.yahoo.co.jpであれば、ヤフージャパンを取得しろという意味になる。

GET以外にも様々なメソッドがある。

GETに似たものとしてPOSTというものがあるが、POSTはECサイトなどで使われる。
GETでは、単純に特定のHTMLファイルの取得するだけでなく、
URLに組み込む形でログインIDやパスワードも送付することができる。

これは便利な機能ではあるが、URLはブラウザの閲覧履歴に残ってしまい、
セキュリティ上非常によろしくない。

そこで、POSTというメソッドは使うとよい。
URL組み込み式ではない形でログインIDなどをやり取りできる為、セキュリティ上好ましい。

##### ● パスとHTTPのバージョン

GETに続くのが、パス名である。
要は、取得したいファイルの場所である。

HTTPのバージョンについては、 ０.9, 1.0, 1.1, 2.0 がある。
詳細については後述する。

#### ○ メッセージヘッダーとは

先ほどの画像でいうところのHostから始まる箇所である。
ここには、ブラウザ情報、対応データタイプ、直前に開いていたページの情報、
データ圧縮方法、対応言語などが記載されている。

#### ○ メッセージボディとは

このリクエストには、メッセージボディがない。
HTMLなどのデータを送信する際、その内容がメッセージヘッダーの後に記載される。

#### ○ ステータス行とは

引き続き、ブログ「ITsakura」さんより画像を拝借する。

<img width="700" alt="WebArchitecture" src="https://itsakura.com/wp-content/uploads/2017/11/http-request-post1.svg"> <br>

これは、サーバー側が返すレスポンスの画像である。
基本的な構成はリクエストと変わらないが、最初の１行目の違いについて触れたい。

レスポンスの最初の１行目だが、これをステータス行という。
まず、HTTPのバージョンが記載された後、「200 OK」と記載されている。

「200 OK」は、レスポンスの処理結果を示している。
「200 OK」は、「うまく処理できたよー」という意味だが、例えば 「www.yahop.co.jp」 と入力して、
ヤフージャパンの情報を取得しそこなった場合には、「404 Not Found」となる。

「200」や「403」などはステータスコードといい、100番台から500番台まで数多く存在する。

### ○ HTTPの歴史

先ほど記載したように、HTTPのバージョンについては、 0.9, 1.0, 1.1, 2.0 がある。
HTTPのバージョンで主流なのは、1.11である。

#### ○ TCPについて

HTTPのやり取りは、以前に学習したとおり、主にTCPという通信の規格が採用されている。
TCPでは、「３ハンドシェイクコネクション」という手法により、互いに通信が可能か確認し合いながら、
データの送受信を行う仕組みとなっている。（３回握手し合って、初めてお友達になる的な感じ）

詳細についての学習は今後の課題とするが、まずクライアントがSYNというパケットを送り、
それを受け取ったサーバーがACKというパケットを送り返す。

一方、サーバーは同様にクライアントにSYNというパケットを送り、
クライアントはそれが受信できたことを示すために、ACKというパケットを送り返す。

これで始めてお友達隣、TCPコネクション確立ということになるようだ。

#### ○ HTTP1.1

HTTP1.1が革新的なのは、このTCPという規格でのやり取りが以前と比較して効率化されたからだ。
効率化を実現させたのは、HTTPキープアライブとHTTPパイプラインという新しい手法だ。

HTTPキープアライブにより、TCPコネクションの確立での無駄が改善された。
これまでは、各通信ごとにお友達にならなければいけなかった。

例えば、同じクライアントであっても、HTMLファイルをもらった後に、そこに埋め込まれている
IMGファイルをもらいに行く時、HTTP１.0以前では疑心暗鬼が激しかったので、
「３ハンドシェイクコネクション」をまた行う必要があった。どれだけ握手するんだ。。。

ただ、HTTPキープアライブにより、こういったことがなくなった。

また、HTTPパイプラインにより、複数のリクエストを同時に行えるようになった。
これまでは、レスポンスが返ってくるまでリクエストを返すことができなかったのだが、
同時に色々とHTMLファイルをGETしろだの、IMGファイルをGETしろだの言えるようになった。

#### ○ HTTP2.0

HTTP2.0になると、HTTPより一層効率化が進んだ。
色々な進化があるようだが、大きな変化して、HTTPパイプラインシステムからの更なる進化がある。

以前は、複数のリクエストを送信することはできたものの、レスポンスの順番というのは守る必要があった。
だが、その順番がグチャグチャになってもよくなったので、IMGファイルのレスポンスが終わらないから、
次のGIFファイルのレスポンスが送れないといった状況が改善された。

#### ○ HTTPS

HTTPSとは、「HTTP over SSL/TLS」の略称である。
以前、HTTPSの「S」は「SecureのS」と書いたが、もしかしたら誤りなのかもしれない。

HTTPSとは、悪意のある者から以下を防ぐプロトコルである。
- 盗聴（暗号化により防ぐ）
- 改竄（データダイジェストにより、サーバーが改竄を検知する）
- なりすまし（SSLサーバ証明書を利用した確認を行う）

### ○ HTTPはステートレス

HTTPは、前のやり取りについての情報を保持しないステートレスな方式を採用している。

Aさんから、「HTMLファイルをくれ」とリクエストを受けた直後に続けて、
「IMGファイルをくれ」とまたリクエストを受けたとしても、ステートレスなのでサーバーは全く記憶していない。

一見よくない仕組みに思えるが、サーバーは大量のリクエストに対応しなければいけないので、
ステートレスの方がサーバーが保持するデータ量が少なく、合理的であると言われている。

#### ○ Cookieとセッション

とはいえ、ずっとステートレスでも困ることがある。
例えば、ECサイトで買い物をする際、そのサイトでログインをして、商品をカゴに入れていき、
そして初めて購入の手続きにうつることになる。

こうしたクライアントとサーバーの一連のやり取りをセッションという。

セッションにおいて、サーバー側が情報を覚えていないと困ることになる。
その場合、cookieを使い、買い物をしている人の情報を保持することができる。
サーバーはセッションIDを発行し、どのような人が買い物をしたか記憶する。

クッキーにも有効期限があるものや、セッションが終わると失効してしまうものもある。
高いセキュリティが求められるWebサイトでは、セッションが終わると失効してしまう
セッションCookieが使われることが多い。
