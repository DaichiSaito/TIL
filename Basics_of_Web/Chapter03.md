# Chapter 3 - HTTPでやり取りする仕組み

### ○ はじめに

改めて、復習です。
Webページの表示にあたっては、HTTPというプロトコルを通して、
自宅PCとサーバーとの間でやり取りがなされている。

自宅のPCが「Webページ表示しろや」と言ったら、サーバー側が「表示したるわ」と言って表示する。
そんな関係性によって成立している。では、HTTPとはどのようなものなのか。

### ○ HTTPとは

HTTPとは、どのような形でやり取りをしているのか。

具体的には、自宅のPC（リクエスト側）はこのような形でやり取りをしている。
（ブログ「ITsakura」さんより画像を拝借しました）

<img width="700" alt="WebArchitecture" src="https://itsakura.com/wp-content/uploads/2017/11/http-request-post1.svg"> <br>

まず、リクエスト行というものがある。
次に、メッセージヘッダーがある。
そして、空行を挟み、メッセージボディがある。（この画像にはないが）

#### ○ リクエスト行とは

##### ● メソッド

まず、メソッドというものがある。
先ほどの図でいうところの「GET」がそうだ。
これは、GETとHTTPの間に挟まれている、「http://~」を取得しろという意味だ。
これが、www.yahoo.co.jpであれば、ヤフージャパンを取得しろという意味になる。

GET以外にも様々なメソッドがある。

GETに似たものとしてPOSTというものがあるが、POSTはECサイトなどで使われる。
GETでは、単純に特定のHTMLファイルの取得するだけでなく、
URLに組み込む形でログインIDやパスワードも送付することができる。

これは便利な機能ではあるが、URLはブラウザの閲覧履歴に残ってしまい、
セキュリティ上非常によろしくない。

そこで、POSTというメソッドは使うとよい。
URL組み込み式ではない形でログインIDなどをやり取りできる為、セキュリティ上好ましい。

##### ● パスとHTTPのバージョン

GETに続くのが、パス名である。
要は、取得したいファイルの場所である。

HTTPのバージョンについては、 ０.9, 1.0, 1.1, 2.0 がある。
詳細については後述する。

#### ○ メッセージヘッダーとは

先ほどの画像でいうところのHostから始まる箇所である。
ここには、ブラウザ情報、対応データタイプ、直前に開いていたページの情報、
データ圧縮方法、対応言語などが記載されている。

#### ○ メッセージボディとは

このリクエストには、メッセージボディがない。
HTMLなどのデータを送信する際、その内容がメッセージヘッダーの後に記載される。

#### ○ ステータス行とは

引き続き、ブログ「ITsakura」さんより画像を拝借する。

<img width="700" alt="WebArchitecture" src="https://itsakura.com/wp-content/uploads/2017/11/http-request-post1.svg"> <br>

これは、サーバー側が返すレスポンスの画像である。
基本的な構成はリクエストと変わらないが、最初の１行目の違いについて触れたい。

レスポンスの最初の１行目だが、これをステータス行という。
まず、HTTPのバージョンが記載された後、「２００ OK」と記載されている。

「２００ OK」は、レスポンスの処理結果を示している。
「２００ OK」は、「うまく処理できたよー」という意味だが、例えば「www.yahop.co.jp」と入力して、
ヤフージャパンの情報を取得しそこなった場合には、「404 Not Found」となる。

「200」や「４０３」などはステータスコードといい、１００番台から５００番台まで数多く存在する。

### ○ HTTPの歴史

先ほど記載したように、HTTPのバージョンについては、 ０.9, 1.0, 1.1, 2.0 がある。
HTTPのバージョンで主流なのは、1.1である。

#### ○ TCPについて

HTTPのやり取りは、以前に学習したとおり、主にTCPという通信の規格が採用されている。
TCPでは、「３ハンドシェイクコネクション」という手法により、互いに通信が可能か確認し合いながら、
データの送受信を行う仕組みとなっている。（３回握手し合って、初めてお友達になる的な感じ）

詳細についての学習は今後の課題とするが、まずクライアントがSYNというパケットを送り、
それを受け取ったサーバーがACKというパケットを送り返す。

一方、サーバーは同様にクライアントにSYNというパケットを送り、
クライアントはそれが受信できたことを示すために、ACKというパケットを送り返す。

これで始めてお友達隣、TCPコネクション確立ということになるようだ。

#### ○ HTTP1.1

HTTP1.1が革新的なのは、このTCPという規格でのやり取りが以前と比較して効率化されたからだ。
効率化を実現させたのは、HTTPキープアライブとHTTPパイプラインという新しい手法だ。

HTTPキープアライブにより、TCPコネクションの確立での無駄が改善された。
これまでは、各通信ごとにお友達にならなければいけなかった。

例えば、同じクライアントであっても、HTMLファイルをもらった後に、そこに埋め込まれている
IMGファイルをもらいに行く時、HTTP１.0以前では疑心暗鬼が激しかったので、
「３ハンドシェイクコネクション」をまた行う必要があった。どれだけ握手するんだ。。。

ただ、HTTPキープアライブにより、こういったことがなくなった。

また、HTTPパイプラインにより、複数のリクエストを同時に行えるようになった。
これまでは、レスポンスが返ってくるまでリクエストを返すことができなかったのだが、
同時に色々とHTMLファイルをGETしろだの、IMGファイルをGETしろだの言えるようになった。

#### ○ HTTP2.0

HTTP2.0になると、HTTPより一層効率化が進んだ。
色々な進化があるようだが、大きな変化して、HTTPパイプラインシステムからの更なる進化がある。

以前は、複数のリクエストを送信することはできたものの、

以上の図のとおり、自宅のPCのChromeやIEなどにWebページが表示されるのは、<br>
ChromeなどのWebブラウザからWebサーバーに対して「〜ページを表示して！」というリクエストが送られ、<br>
それを受けたWebサーバーが該当のファイルを送り返しているからである。<br>

そのやり取りを行うにあたって使われているのが、HTTP（HyperText Transfer Protocol)という<br>
規格や、より安全なHTTPSという規格である。<br>

「〜ページを表示して！」というリクエストの行き先は、統一資源位置指定子！！！（URLのことです。。。）に<br>
よって特定され、IPアドレスという番号の羅列に変換されて、初めてPCが分かる行き先になる。<br>

Webサーバーから送られるファイルは、サーバー内のサーバーサイド言語（Ruby・PHP・Python）などによって、<br>
その都度生成されることがあり、これを「動的ページ」という。<br>

ちなみに、FacebookやInstagramがユーザーごとにカスタマイズしたページを表示できるのは、<br>
Webブラウザから受け取った情報を元にして、動的にWebページを生成しているからである。<br>

### ○ DNSについて

先ほどの説明だと、単純にWebページの表示は自宅のPCとWebサーバーのみで完結しているように思われる。<br>
だが、実際には、IPアドレスを見つける為に、その間にはDNSサーバーが介在している。<br>

単純に自宅のPCがダイレクトにWebサーバーに行けるわけではなく、IPアドレス取得のため、<br>
DNSサーバーへのスタンプラリーを終えなければいけない。<br>

<img width="700" alt="WebArchitecture" src="https://www.nic.ad.jp/ja/dom/img/basics_b.gif"> <br>

これがそのスタンプラリーの様子だ。<br>
会社の稟議のように、DNSルートサーバーを始めとして、多くのDNSサーバーを媒介しなければならない。<br>

ところで、DNSとはDomain Network Systemの略称である。<br>
要は、場所を特定するためのネットワークシステムということである。<br>

文字どおり、場所特定のためのスーパーコンピュータがあるわけではなく、<br>
複数のコンピュータが繋がった形で、それぞれが協力してIPアドレスを特定しているのである。<br>

><a href="https://www.nic.ad.jp/ja/dom/system.html">ドメイン名のしくみ</a><br>
一般社団法人日本ネットワークインフォメーションセンターHP

### ○ TCP/IPについて

TCP/IPとは、インターネット上のプロトコルの総称を指す。<br>
例えば、以下のようなプロトコルがある。<br>
- HTTP（HTMLのプロトコル）
- FTP（Fileのプロトコル）
- SMTP（メール送信のプロトコル）
- POP（メール受信のプロトコル）<br>

ちなみに、TCP/IPはいくつものレイヤー（層）に分かれている。<br>
HTTPやFTPはアプリケーションというレイヤーに属している。<br>

><a href="https://tomslifestylelab.com/tcp-ip/">TCP/IPとは？初心者がTCP/IPを理解するための完全ガイド</a><br>
ブログ 「LIFESTYLE LAB（ライフスタイルラボ）」

><a href="https://qiita.com/naoki_mochizuki/items/7ee0e01db61e1e7abd62">[インターネット通信の流れ]</a><br>
Qiita記事 @naoki_mochizuki

